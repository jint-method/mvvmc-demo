function e(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}class s{constructor(){this.worker,this.setupBroadcastWorker(),this.inboxes=[],this.messageQueue=[],this.state={allowMessaging:!1},window.addEventListener("unload",()=>{this.worker.postMessage({recipient:"broadcast-worker",data:{type:"unload"}})})}async setupBroadcastWorker(){let e,s=await fetch("https://cdn.jsdelivr.net/npm/wwibs@0.1.2/wwibs-worker.min.js");if(s.ok){const t=await s.blob();e=URL.createObjectURL(t)}else if(s=await fetch("/wwibs-worker.min.js"),s.ok){const t=await s.blob();e=URL.createObjectURL(t)}e&&(this.worker=new Worker(e),this.worker.onmessage=this.handleWorkerMessage.bind(this))}flushMessageQueue(){if(this.state.allowMessaging=!0,this.messageQueue.length)for(let e=0;e<this.messageQueue.length;e++)this.worker.postMessage(this.messageQueue[e]);this.messageQueue=[]}sendDataToInboxes(e,s){for(let t=0;t<e.length;t++)try{this.inboxes[e[t]].callback(s)}catch(s){this.disconnectInbox(this.inboxes[e[t]],e[t])}}handleWorkerMessage(e){var s;const t=e.data;"broadcaster"===(null===(s=t.recipient)||void 0===s?void 0:s.trim().toLowerCase())?this.inbox(t.data):this.sendDataToInboxes(t.inboxIndexes,t.data)}sendUserDeviceInformation(){var e,s;const t={senderId:null,recipient:"broadcast-worker",messageId:null,maxAttempts:1,data:{type:"init",memory:null!==(s=null===(e=window.navigator)||void 0===e?void 0:e.deviceMemory)&&void 0!==s?s:8,isSafari:navigator.userAgent.search("Safari")>=0&&navigator.userAgent.search("Chrome")<0}};this.postMessageToWorker(t)}inbox(e){const{type:s}=e;switch(s){case"worker-ready":this.flushMessageQueue(),this.sendUserDeviceInformation();break;case"cleanup-complete":this.state.allowMessaging=!0,this.flushMessageQueue();break;case"cleanup":this.cleanup()}}message(s){var t,a,o;const l={recipient:s.recipient,type:s.type,data:null!==(t=null==s?void 0:s.data)&&void 0!==t?t:{},senderId:null!==(a=null==s?void 0:s.senderId)&&void 0!==a?a:null,maxAttempts:null!==(o=null==s?void 0:s.maxAttempts)&&void 0!==o?o:1,messageId:e()};this.postMessageToWorker(l)}hookup(s,t){const a={callback:t,uid:e()},o=this.inboxes.length;this.inboxes.push(a);const l={senderId:a.uid,recipient:"broadcast-worker",messageId:null,maxAttempts:1,data:{type:"hookup",name:s,inboxAddress:o,uid:a.uid}};return this.postMessageToWorker(l),a.uid}disconnect(e){for(let s=0;s<this.inboxes.length;s++){const t=this.inboxes[s];if(t.uid===e){this.disconnectInbox(t,s);break}}}reply(s){var t,a,o;const l={replyId:s.replyId,type:s.type,data:null!==(t=null==s?void 0:s.data)&&void 0!==t?t:{},senderId:null!==(a=null==s?void 0:s.senderId)&&void 0!==a?a:null,maxAttempts:null!==(o=null==s?void 0:s.maxAttempts)&&void 0!==o?o:1,messageId:e()};this.postMessageToWorker(l)}replyAll(s){var t,a,o;const l={replyId:s.replyId,type:s.type,data:null!==(t=null==s?void 0:s.data)&&void 0!==t?t:{},senderId:null!==(a=null==s?void 0:s.senderId)&&void 0!==a?a:null,maxAttempts:null!==(o=null==s?void 0:s.maxAttempts)&&void 0!==o?o:1,messageId:e(),replyAll:!0};this.postMessageToWorker(l)}disconnectInbox(e,s){e.disconnected=!0,e.callback=()=>{};const t={senderId:null,recipient:"broadcast-worker",messageId:null,maxAttempts:1,data:{type:"disconnect",inboxAddress:s}};this.postMessageToWorker(t)}postMessageToWorker(e){this.state.allowMessaging?this.worker.postMessage(e):this.messageQueue.push(e)}cleanup(){this.state.allowMessaging=!1;const e=[],s=[];for(let t=0;t<this.inboxes.length;t++){const a=this.inboxes[t];if(!(null==a?void 0:a.disconnected)){const o={oldAddressIndex:t,newAddressIndex:s.length};s.push(a),e.push(o)}}this.inboxes=s;const t={senderId:null,recipient:"broadcast-worker",messageId:null,maxAttempts:1,data:{type:"update-addresses",addresses:e}};this.worker.postMessage(t)}}let t=document.head.querySelector("script#broadcaster")||null;t||(t=document.createElement("script"),t.id="broadcaster",t.innerHTML="window.globalManager = null;window.globalMessage = null;window.globalHookup = null;window.globalDisconnect = null;window.globalReply = null;window.globalReplyAll = null;",document.head.appendChild(t),globalManager=new s),globalMessage=globalManager.message.bind(globalManager);const a=globalMessage;globalHookup=globalManager.hookup.bind(globalManager);const o=globalHookup;globalDisconnect=globalManager.disconnect.bind(globalManager);const l=globalDisconnect;globalReply=globalManager.reply.bind(globalManager);const n=globalReply;globalReplyAll=globalManager.replyAll.bind(globalManager);const i=globalReplyAll;export{l as disconnect,o as hookup,a as message,n as reply,i as replyAll};