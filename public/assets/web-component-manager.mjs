import{env as e}from"./env.mjs";import{minimumConnection as t,djinnjsOutDir as o}from"./config.mjs";export class WebComponentManager{constructor(){this.intersectionCallback=o=>{for(let n=0;n<o.length;n++)if(o[n].isIntersecting){const i=o[n].target,s=i.tagName.toLowerCase().trim(),c=i.getAttribute("required-connection")||t;void 0===customElements.get(s)?e.checkConnection(c)&&(this.io.unobserve(i),this.upgradeToWebComponent(s,i)):(this.io.unobserve(i),i.setAttribute("component-state","mounted"))}},this.io=new IntersectionObserver(this.intersectionCallback)}removeRequiredConnections(){const e=Array.from(document.body.querySelectorAll("[web-component]"));for(let t=0;t<e.length;t++){e[t].setAttribute("required-connection","slow-2g")}}removePurgeableComponents(){const o=Array.from(document.body.querySelectorAll("[web-component][removable]"));for(let n=0;n<o.length;n++){const i=o[n],s=i.getAttribute("required-connection")||t;void 0===customElements.get(i.tagName.toLowerCase().trim())&&(e.checkConnection(s)||(this.io.unobserve(i),i.remove()))}}collectWebComponents(){const e=sessionStorage.getItem("connection-choice");"full"===e?this.removeRequiredConnections():"lite"===e&&this.removePurgeableComponents(),this.handleWebComponents()}async upgradeToWebComponent(t,n){if(void 0===customElements.get(t)){const i=e.startLoading(),s=await import(`${location.origin}/${o}/${t}.mjs`);void 0===customElements.get(t)&&customElements.define(t,s.default),n.setAttribute("component-state","mounted"),e.stopLoading(i)}else n.setAttribute("component-state","mounted")}handleWebComponents(){const o=Array.from(document.body.querySelectorAll("[web-component]:not([component-state])"));for(let n=0;n<o.length;n++){const i=o[n],s=i.getAttribute("loading"),c=i.getAttribute("required-connection")||t;if("eager"===s&&e.checkConnection(c)){const e=i.tagName.toLowerCase().trim();this.upgradeToWebComponent(e,i)}else i.setAttribute("component-state","unseen"),this.io.observe(o[n])}if(("2g"===e.connection||"slow-2g"===e.connection||"3g"===e.connection)&&null===sessionStorage.getItem("connection-choice"))if(e.dataSaver)sessionStorage.setItem("connection-choice","lite"),this.removePurgeableComponents();else{const e=new CustomEvent("djinn:lightweight-check");document.dispatchEvent(e)}}}